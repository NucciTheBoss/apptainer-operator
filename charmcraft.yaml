# Copyright 2025 Omnivector, LLC
# See LICENSE file for licensing details.
name: apptainer
summary: |
  Apptainer (formerly Singularity) simplifies the creation and execution of
  containers, ensuring software components are encapsulated for portability and reproducibility.

description: |
  This subordinate charm installs the `apptainer` package when integrated
  with a primary charm and removes the package from the system when the
  integration between the primary and subordinate charm is removed.

  Apptainer is installed by this charm from the upstream ppa
  located at https://ppa.launchpadcontent.net/apptainer/ppa/ubuntu.

links:
  contact: https://matrix.to/#/#hpc:ubuntu.com

  issues:
  - https://github.com/charmed-hpc/apptainer-operator/issues

  source:
  - https://github.com/charmed-hpc/apptainer-operator

assumes:
  - juju

type: charm
base: ubuntu@24.04
platforms:
  amd64:

subordinate: true

requires:
  juju-info:
    interface: juju-info
    scope: container

parts:
  charm:
    build-packages: [git]
  # Create a version file and pack it into the charm. This is dynamically generated
  # as part of the build process for a charm to ensure that the git revision of the
  # charm is always recorded in this version file.
  version-file:
    plugin: nil
    build-packages:
      - git
    override-build: |
      VERSION=$(git -C $CRAFT_PART_SRC/../../charm/src describe --dirty --always)
      echo "Setting version to $VERSION"
      echo $VERSION > $CRAFT_PART_INSTALL/version
    stage:
      - version

actions:
  upgrade:
    description: Upgrade apptainer to the latest release.
